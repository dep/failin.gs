<% div_for failing, class: "feedback #{css_class_for failing.state}" do %>
  <div class="toolbar<%= ' move' if current_user == failing.user %>">
    <strong><%= failing.votes_score %></strong> votes
    <% unless voted_on? failing %>
      |
      <%= link_to_remote "agree", url: failing_vote_path(failing.user, failing, agree: true), method: :post %> -
      <%= link_to_remote "disagree", url: failing_vote_path(failing.user, failing), method: :post %>
    <% end %>
  </div>
  <div class="feedback_text">
    <%= simple_format(h(failing.about)).html_safe! %>
  </div>
  <div id="<%= dom_id failing, :comments %>">
    <%= render failing.comments %>
  </div>
  <div class="toolbar bottom">
    <% if failing.user == current_user && failing.needs_review? %>
      <div class="left">
        <img src="/images/icon_knew.png" alt="I knew this" />
        <%= link_to_remote "I knew this", url: knew_failing_path(failing.user, failing), method: :put %>
        <img src="/images/icon_no_idea.png" alt="I had no idea!" />
        <%= link_to_remote "I had no idea!", url: no_idea_failing_path(failing.user, failing), method: :put %>
        <img src="/images/icon_disagree.png" alt="I disagree completely" />
        <%= link_to_remote "I disagree completely", url: disagree_failing_path(failing.user, failing), method: :put %>
      </div>
    <% end %>
    <div class="right">
      <span onclick="">report abuse</span> -
      <span onclick="this.up('.feedback').select('.reply_wrapper')[0].show().select('textarea')[0].focus()">reply</span>
    </div>
  </div>
  <div class="reply_wrapper" style="display: none;">
    <% remote_form_for failing.comments.build, url: failing_comment_path(failing.user, failing) do |f| %>
      <div>
        <%= f.text_area :text, :rows => "2" %>
        <%= f.submit %>
      </div>
    <% end %>
  </div>
  <div class="reply_wrapper" style="display: none;">
    <% form_for failing.comments.build, url: failing_comment_path(failing.user, failing) do |f| %>
      <div>
        <%= f.text_area :text, :rows => "2" %>
        <%= f.submit %>
      </div>
    <% end %>
  </div>
<% end %>

<% if failing.user == current_user %>
  <script>
    new Draggable("<%= dom_id failing %>", {
      handle: ".toolbar",
      revert: true
    });
  </script>
<% end %>
